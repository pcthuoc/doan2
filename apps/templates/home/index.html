{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

{% block stylesheets %}
<style>
    .toggle-switch {
        display: none;
    }

    .toggle-label {
        display: block;
        width: 50px;
        height: 30px;
        background-color: #797979;
        border-radius: 20px;
        position: relative;
        cursor: pointer;
    }

    .toggle-label::after {
        content: '';
        position: absolute;
        top: 1px;
        left: 2px;
        width: 28px;
        height: 28px;
        background-color: #fffffff0;
        border-radius: 50%;
        transition: all 0.3s;
    }

    .toggle-switch:checked + .toggle-label {
        background-color: #ff3e20;
    }

    .toggle-switch:checked + .toggle-label::after {
        left: calc(100% - 2px);
        transform: translateX(-100%);
    }

    .sensor-item, .relay-item {
        margin-bottom: 20px; /* Thêm khoảng cách giữa các mục */
    }

    .sensor-item {
        padding: 15px; /* Thêm khoảng cách bên trong phần tử cảm biến */
        border: 1px solid #ddd; /* Thêm viền cho các phần tử cảm biến */
        border-radius: 5px; /* Bo tròn góc của các phần tử cảm biến */
        background-color: #f9f9f9; /* Màu nền của các phần tử cảm biến */
    }

    .sensor-item .value {
        font-size: 24px; /* Tăng kích thước của giá trị cảm biến */
        font-weight: bold; /* Đậm giá trị cảm biến */
    }

    .sensor-item .unit {
        font-size: 16px; /* Kích thước đơn vị cảm biến */
        color: #666; /* Màu sắc của đơn vị cảm biến */
    }

    .sensor-item .name {
        font-size: 14px; /* Kích thước tên cảm biến */
        color: #333; /* Màu sắc của tên cảm biến */
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="pc-container">
    <div class="pcoded-content">
        <div class="row">
            <!-- Cột cảm biến -->
            <div class="col-xl-6 col-md-12">
                <div class="card flat-card" id="sensors">
                    <div class="row">
                        {% for sensor in sensors %}
                        {% if forloop.counter0|divisibleby:3 and not forloop.first %}
                        </div><div class="row">
                        {% endif %}
                        <div class="col-sm-4 d-none d-md-table-cell d-lg-table-cell d-xl-table-cell card-body br">
                            <div class="row align-items-center">
                                <div class="col-sm-4 text-center">
                                    <i class="material-icons-two-tone text-primary mb-1">language</i>
                                </div>
                                <div class="col-sm-8">
                                    <h5>{{ sensor.value }} {{ sensor.unit }}</h5>
                                    <span>{{ sensor.name }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Cột relay -->
            <div class="col-xl-6 col-md-12">
                <div class="row" id="relays">
                    {% for relay in relays %}
                    <div class="col-sm-6 relay-item">
                        <div class="card prod-p-card background-pattern">
                            <div class="card-body">
                                <div class="row align-items-center m-b-0">
                                    <div class="col">
                                        <h3 class="m-b-0">{{ relay.name }}</h3>
                                    </div>
                                    <div class="col-auto">
                                        <input type="checkbox" id="relay-toggle-{{ relay.id }}" class="toggle-switch" {% if relay.value == "1" %}checked{% endif %}>
                                        <label for="relay-toggle-{{ relay.id }}" class="toggle-label" onclick="toggleRelay('{{ relay.id }}', '{{ relay.pin }}', '{{ relay.api_key }}')"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if forloop.counter|divisibleby:2 %}
                    </div><div class="row">
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="/static/assets/js/plugins/apexcharts.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const ws = new WebSocket('ws://' + window.location.host + '/ws/notifications/');
    console.log(ws);

    ws.onopen = () => {
        console.log('WebSocket connection established');
    };
    ws.onerror = (error) => {
        console.error('WebSocket error: ', error);
    };
    ws.onclose = () => {
        console.log('WebSocket connection closed');
    };
    ws.onmessage = (event) => {
        loadData();
    };

    function loadData() {
        $.ajax({
            url: "{% url 'home' %}"
        }).done(function (data) {
            $('#sensors').html($(data).find('#sensors').html());
            $('#relays').html($(data).find('#relays').html());
        });
    }

    function toggleRelay(relayId, relayPin, apikey) {
        const relayCheckbox = document.getElementById('relay-toggle-' + relayId);
        const value = relayCheckbox.checked ? 0 : 1;
        const url = `${window.location.protocol}//${window.location.hostname}:${window.location.port}/update/${apikey}/${relayPin}/?value=${value}`;

        fetch(url, { method: 'GET' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                console.log('Request sent successfully');
            })
            .catch(error => {
                console.error('Error sending request:', error);
            });
    }
</script>
{% endblock javascripts %}
