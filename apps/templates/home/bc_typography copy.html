{% extends "layouts/base.html" %}

{% block title %}Quản lý lịch trình{% endblock %}

{% block stylesheets %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<style>
    .edit-btn {
        color: #26af5d;
        /* Màu xanh lá cây cho nút chỉnh sửa */
        font-size: 1.2em;
        text-decoration: none;
        margin-right: 20px;
        /* Thêm khoảng cách giữa các biểu tượng */
    }

    .delete-btn {
        color: #eb5765;
        /* Màu đỏ cho nút xóa */
        font-size: 1.2em;
        text-decoration: none;
    }

    .edit-btn:hover {
        color: #26af5d71;
        /* Màu xanh lá cây đậm hơn khi hover */
    }

    .delete-btn:hover {
        color: #eb576656;
        /* Màu đỏ đậm hơn khi hover */
    }

    .table td {
        vertical-align: middle;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock stylesheets %}

{% block content %}
<div class="pc-container">
    <div class="pcoded-content">
        <div class="d-flex">
            <div>
                <h1 class="mt-4">Quản lý lịch trình</h1>
            </div>
            <div class="ms-auto mt-4">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#CreateFormModalGio" id="ad_gio">Cài đặt hẹn giờ</button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal"
                    data-bs-target="#CreateFormModalNguong" id="ad_nguong">Cài đặt ngưỡng</button>
            </div>
        </div>
        <div class="row">
            <!-- [ basic-table ] start -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Danh sách hẹn giờ</h5>
                    </div>
                    <div class="card-body table-border-style">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Tên thiết bị</th>
                                        <th scope="col">Trạng thái</th>
                                        <th scope="col">Thời gian</th>
                                        <th scope="col">Ngày</th>
                                        <th scope="col">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for hengio in hengios %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ hengio.name }}</td>
                                        <td>
                                            {% if hengio.status == 1 %}
                                            Bật
                                            {% else %}
                                            Tắt
                                            {% endif %}
                                        </td>
                                        <td>{{ hengio.time }}</td>
                                        <td>{{ hengio.days_of_week }}</td>
										<td>
											<a href="#" class="edit-btn" data-id="{{ hengio.id }}"
												data-name="{{ hengio.name }}" data-status="{{ hengio.status }}"
												data-time="{{ hengio.time }}" data-days="{{ hengio.days_of_week }}">
												<i class="fas fa-edit"></i>
											</a>
											<a href="#" class="delete-btn" onclick="removeItemHengio('{{ hengio.id }}')">
												<i class="fas fa-trash-alt"></i>
											</a>
										</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ basic-table ] end -->
            <!-- [ inverse-table ] start -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Danh sách đặt ngưỡng</h5>
                    </div>
                    <div class="card-body table-border-style">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Tên Sensor</th>
                                        <th scope="col">Ngưỡng</th>
                                        <th scope="col">Trạng thái</th>
                                        <th scope="col">Thời gian</th>
                                        <th scope="col">Ngày</th>
                                        <th scope="col">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for setnguong in setnguongs %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ setnguong.sensor_name }}</td>
                                        <td>
                                            {% if setnguong.compare == 1 %}
                                            {{ setnguong.relay_name }} lớn hơn {{ setnguong.compare_value }}
                                            {% else %}
                                            {{ setnguong.relay_name }} nhỏ hơn {{ setnguong.compare_value }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if setnguong.status == 1 %}
                                            Bật
                                            {% else %}
                                            Tắt
                                            {% endif %}
                                        </td>
                                        <td>{{ setnguong.time }}</td>
                                        <td>{{ setnguong.days_of_week }}</td>
										<td>
											<a href="#" class="edit-btn" data-id="{{ setnguong.id }}"
												data-name="{{ setnguong.sensor_name }}" data-threshold="{{ setnguong.compare_value }}"
												data-status="{{ setnguong.status }}" data-time="{{ setnguong.time }}"
												data-days="{{ setnguong.days_of_week }}">
												<i class="fas fa-edit"></i>
											</a>
											<a href="#" class="delete-btn" onclick="removeItemSetnguong('{{ setnguong.id }}')">
												<i class="fas fa-trash-alt"></i>
											</a>
										</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ inverse-table ] end -->
        </div>
    </div>
</div>

<!-- Modal for creating new schedule -->
<div class="modal fade" id="CreateFormModalNguong" tabindex="-1" aria-labelledby="FormModalLabelNguong"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="FormModalLabelNguong">Cài đặt ngưỡng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-form-nguong" action="" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="nguong-id">
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Tên sensor:</label>
                        <select class="form-select" name="sensor" id="sensor">
                            {% for sensor in sensors %}
                            <option value="{{ sensor.id }}" data-api="{{ sensor.api_key }}"
                                data-name="{{ sensor.name }}" data-pin="{{ sensor.pin }}">{{ sensor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="compare" class="col-form-label">Trạng thái:</label>
                        <select class="form-select" name="compare" id="compare">
                            <option value="1">Lớn hơn hoặc bằng</option>
                            <option value="2">Nhỏ hơn hoặc bằng</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="compare_value" class="col-form-label">Giá trị so sánh:</label>
                        <input type="text" class="form-control" name="compare_value" id="compare_value">
                    </div>
                    <div class="mb-3">
                        <label for="relay" class="col-form-label">Tên relay:</label>
                        <select class="form-select" name="relay" id="relay">
                            {% for relay in relays %}
                            <option value="{{ relay.id }}" data-api="{{ relay.api_key }}"
                                data-name="{{ relay.name }}" data-pin="{{ relay.pin }}">{{ relay.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status1" class="col-form-label">Trạng thái:</label>
                        <select class="form-select" name="status1" id="status1">
                            <option value="1">Bật</option>
                            <option value="2">Tắt</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trigger_time1" class="col-form-label">Thời gian kích hoạt:</label>
                        <input type="text" class="form-control flatpickr-time" name="trigger_time1" id="trigger_time1"
                            autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="days_of_week1" class="col-form-label">Chọn các ngày trong tuần:</label>
                        {% include 'includes/checkbox_days_of_week.html' with name="days_of_week1" %}
                    </div>
                </form>
            </div>
            <div class="modal-footer" id="ModalFooterNguong">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-warning" id="submit-form-nguong">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for creating new threshold -->
<div class="modal fade" id="CreateFormModalNguong" tabindex="-1" aria-labelledby="FormModalLabelNguong"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="FormModalLabelNguong">Cài đặt ngưỡng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-form-nguong" action="{% url 'addnguong' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Tên sensor:</label>
                        <select class="form-select" name="sensor" id="sensor">
                            {% for sensor in sensors %}
                            <option value="{{ sensor.id }}" data-api="{{ sensor.api_key }}"
                                data-name="{{ sensor.name }}" data-pin="{{ sensor.pin }}">{{ sensor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="compare" class="col-form-label">Trạng thái:</label>
                        <select class="form-select" name="compare" id="compare">
                            <option value="1">Lớn hơn hoặc bằng</option>
                            <option value="2">Nhỏ hơn hoặc bằng</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="compare_value" class="col-form-label">Giá trị so sánh:</label>
                        <input type="text" class="form-control" name="compare_value" id="compare_value">
                    </div>
                    <div class="mb-3">
                        <label for="relay" class="col-form-label">Tên relay:</label>
                        <select class="form-select" name="relay" id="relay">
                            {% for relay in relays %}
                            <option value="{{ relay.id }}" data-api="{{ relay.api_key }}"
                                data-name="{{ relay.name }}" data-pin="{{ relay.pin }}">{{ relay.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status1" class="col-form-label">Trạng thái:</label>
                        <select class="form-select" name="status1" id="status1">
                            <option value="1">Bật</option>
                            <option value="2">Tắt</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trigger_time1" class="col-form-label">Thời gian kích hoạt:</label>
                        <input type="text" class="form-control flatpickr-time" name="trigger_time1" id="trigger_time1"
                            autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="days_of_week1" class="col-form-label">Ngày trong tuần:</label>
                        <select class="form-select" name="days_of_week1" id="days_of_week1" multiple>
                            <option value="0">Thứ Hai</option>
                            <option value="1">Thứ Ba</option>
                            <option value="2">Thứ Tư</option>
                            <option value="3">Thứ Năm</option>
                            <option value="4">Thứ Sáu</option>
                            <option value="5">Thứ Bảy</option>
                            <option value="6">Chủ Nhật</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer" id="ModalFooterNguong">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-warning" id="submit-form-nguong">Thêm</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
$(document).ready(function () {
    // Function to populate form for editing
    function populateForm(data, formId) {
        $(`${formId} #gio-id`).val(data.id);
        $(`${formId} #relay`).val(data.relay).change();
        $(`${formId} #status`).val(data.status).change();
        $(`${formId} #trigger_time`).val(data.trigger_time);
        const daysOfWeek = data.days_of_week.split(',');
        daysOfWeek.forEach(day => {
            $(`${formId} #days_of_week_${day}`).prop('checked', true);
        });
    }

    $("#submit-form-gio").click(function () {
        const formId = '#create-form-gio';
        var csrfToken = $(`${formId} [name=csrfmiddlewaretoken]`).val();
        var daysOfWeek = [];
        $(`${formId} input[name="days_of_week"]:checked`).each(function() {
            daysOfWeek.push($(this).val());
        });
        var daysOfWeekString = daysOfWeek.join(',');

        var formData = {
            'id': $(`${formId} #gio-id`).val(),
            'name': $(`${formId} #relay option:selected`).data('name'),
            'api_key': $(`${formId} #relay option:selected`).data('api'),
            'pin': $(`${formId} #relay option:selected`).data('pin'),
            'status': $(`${formId} #status`).val(),
            'trigger_time': $(`${formId} #trigger_time`).val(),
            'days_of_week': daysOfWeekString,
            'csrfmiddlewaretoken': csrfToken
        };

        const actionUrl = formData.id ? `{% url 'editgio' %}` : `{% url 'addgio' %}`;
        
        $.ajax({
            type: 'POST',
            url: actionUrl,
            data: formData,
            success: function (data) {
                window.location.href = "/scene";
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log('Error:', errorThrown);
            }
        });
    });

    $("#submit-form-nguong").click(function () {
        const formId = '#create-form-nguong';
        var csrfToken = $(`${formId} [name=csrfmiddlewaretoken]`).val();
        var daysOfWeek = [];
        $(`${formId} input[name="days_of_week1"]:checked`).each(function() {
            daysOfWeek.push($(this).val());
        });
        var daysOfWeekString = daysOfWeek.join(',');

        var formData = {
            'id': $(`${formId} #nguong-id`).val(),
            'sensor_pin': $(`${formId} #sensor option:selected`).data('pin'),
            'sensor_name': $(`${formId} #sensor option:selected`).data('name'),
            'relay_name': $(`${formId} #relay option:selected`).data('name'),
            'relay_pin': $(`${formId} #relay option:selected`).data('pin'),
            'api_key': $(`${formId} #relay option:selected`).data('api'),
            'compare': $(`${formId} #compare`).val(),
            'compare_value': $(`${formId} #compare_value`).val(),
            'status': $(`${formId} #status1`).val(),
            'trigger_time1': $(`${formId} #trigger_time1`).val(),
            'days_of_week': daysOfWeekString,
            'csrfmiddlewaretoken': csrfToken
        };

        const actionUrl = formData.id ? `{% url 'editnguong' %}` : `{% url 'addnguong' %}`;
        
        $.ajax({
            type: 'POST',
            url: actionUrl,
            data: formData,
            success: function (data) {
                window.location.href = "/scene";
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log('Error:', errorThrown);
            }
        });
    });

    // Function to handle the remove item action for Hengio
    window.removeItemHengio = function (id) {
        if (confirm('Bạn có chắc chắn muốn xóa mục này?')) {
            fetch(`/delete-hengio/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Đã xóa thành công!');
                    location.reload();
                } else {
                    alert('Xóa thất bại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Xóa thất bại!');
            });
        }
    }

    // Function to handle the remove item action for Setnguong
    window.removeItemSetnguong = function (id) {
        if (confirm('Bạn có chắc chắn muốn xóa mục này?')) {
            fetch(`/delete-setnguong/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Đã xóa thành công!');
                    location.reload();
                } else {
                    alert('Xóa thất bại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Xóa thất bại!');
            });
        }
    }

    flatpickr(".flatpickr-time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        static: true
    });
});

</script>

<script>
    flatpickr(".flatpickr-time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        static: true
    });
</script>
{% endblock javascripts %}
